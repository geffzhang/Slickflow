var activityproperty=function(){function a(){}function b(b){function g(){e.api.getSelectedRows().forEach(function(b,c){a.mselectedActivityPerformerGUID=b.id})}var d=document.querySelector("#myPerformerGrid");$(d).empty();var e={columnDefs:[{headerName:"ID",field:"id",width:160},{headerName:"角色名称",field:"name",width:160},{headerName:"角色代码",field:"code",width:160}],rowSelection:"single",onSelectionChanged:g};new agGrid.Grid(d,e);var f=c(b);e.api.setRowData(f)}function c(a){var b=null,c=[];if(a.performers&&a.performers.length>0)for(var e=0;e<a.performers.length;e++)(b=d(a.performers[e].id))&&c.push(b);return c}function d(a){var b=null,c=kmain.mxSelectedParticipants;if(c&&c.length>0)for(var d=0;d<c.length;d++){var e=c[d];if(a===e.id){b={id:e.id,name:e.name,code:e.code,outerId:e.outerId};break}}return b}return a.mselectedActivityPerformerGUID="",a.loadActivity=function(){$("#ddlComplexType").prop("selectedIndex",-1),$("#ddlMergeType").prop("selectedIndex",-1),$("#ddlCompareType").prop("selectedIndex",-1);var a=kmain.mxSelectedDomElement.Element;a&&($("#txtActivityName").val(a.name),$("#txtActivityCode").val(a.code),$("#txtDescription").val(a.description),b(a),a.type===kmodel.Config.NODE_TYPE_MULTIPLEINSTANCE?($("#divMultipleInstanceContent").show(),$("#ddlComplexType").val(a.complexType),$("#ddlMergeType").val(a.mergeType),$("#ddlCompareType").val(a.compareType),$("#txtCompleteOrder").val(a.completeOrder)):$("#divMultipleInstanceContent").hide())},a.saveActivity=function(){var a=$("#txtActivityName").val(),b=$("#txtActivityCode").val(),c=$("#txtDescription").val(),d=kmain.mxSelectedDomElement.Element;d&&(d.name=a,d.code=b,d.description=c,d.type===kmodel.Config.NODE_TYPE_MULTIPLEINSTANCE&&(d.complexType=$("#ddlComplexType").val(),d.mergeType=$("#ddlMergeType").val(),d.compareType=$("#ddlCompareType").val(),d.completeOrder=$("#txtCompleteOrder").val()),kmain.setVertexValue(d))},a.addPerformer=function(){BootstrapDialog.show({title:"角色列表",message:$("<div></div>").load("role/list")})},a.syncActivityPerformers=function(a,c){var d=kmain.mxSelectedDomElement.Element,e=d.performers;e||(e=d.performers=[]);for(var f=kmain.mxSelectedPackageData.participants,g=null,h=0;h<f.length;h++)if("role"===a&&"Role"===f[h].type&&c.ID===f[h].outerId){g=f[h];break}if(g){for(var i=!1,h=0;h<e.length;h++)if(g.id===e[h].id){i=!0;break}if(i)$.msgBox({title:"Desinger / ActivityProperty",content:"要添加的角色或用户数据已经存在！",type:"info"});else{var j={id:g.id,name:g.name,code:g.code,outerId:g.outerId};d.performers.push(j),b(d),kmain.setVertexPerformers(d.performers)}}else if("role"===a){var k={id:jshelper.getUUID(),type:"Role",name:c.RoleName,code:c.RoleCode,outerId:c.ID};kmain.mxSelectedParticipants.push(k);var j={id:k.id,name:k.name,code:k.code,outerId:k.outerId};d.performers.push(j),b(d),kmain.setVertexPerformers(d.performers)}},a.delPerformer=function(){var c=a.mselectedActivityPerformerGUID,d=kmain.mxSelectedDomElement.Element,e=d.performers;d.performers=jQuery.grep(e,function(a){return a.id!==c}),b(d),kmain.setVertexPerformers(d.performers)},a}(),gatewayproperty=function(){function a(){}return a.splitOptions=[{value:"AndSplit",text:"与分支"},{value:"OrSplit",text:"或分支"}],a.joinOptions=[{value:"AndJoin",text:"与合并"},{value:"OrJoin",text:"或合并"}],a.loadGatewayInformation=function(){var b=kmain.mxSelectedDomElement.Element;if(b&&($("#txtDescription").val(b.description),b.gatewaySplitJoinType)){var c=b.gatewaySplitJoinType;$("#ddlGatewayType").val(c),$("#ddlGatewayType").attr("disabled",!0),a.appendDirectionType(c),b.gatewayDirection&&$("#ddlDirectionType").val(b.gatewayDirection)}$("#ddlGatewayType").change(function(){var b=$("#ddlGatewayType").val();a.appendDirectionType(b)})},a.appendDirectionType=function(b){$("#ddlDirectionType").empty().append('<option value="default" selected>--请选择--</option>');var c=null;if("Split"==b)for(var d=0;d<a.splitOptions.length;d++)c=a.splitOptions[d],$("#ddlDirectionType").append($("<option></option>").attr("value",c.value).text(c.text));else if("Join"==b)for(var d=0;d<a.joinOptions.length;d++)c=a.joinOptions[d],$("#ddlDirectionType").append($("<option></option>").attr("value",c.value).text(c.text))},a.saveGatewayInformation=function(){var a=$("#txtDescription").val(),b=$("#ddlGatewayType").val(),c=$("#ddlDirectionType").val();if("default"==b)return void $.msgBox({title:"Designer / GatewayProperty",content:"请重新选择分支合并类型！",type:"info"});if("default"==c)return void $.msgBox({title:"Designer / GatewayProperty",content:"请重新选择分支合并的子类型！",type:"info"});var d=kmain.mxSelectedDomElement.Element;d&&(d.description=a,d.gatewaySplitJoinType=b,d.gatewayDirection=c,kmain.setVertexValue(d))},a}(),kloader=function(){function a(){}function b(a,b){a.writeStartElement("WorkflowProcesses"),a.writeStartElement("Process"),a.writeAttributeString("name",b.ProcessName),a.writeAttributeString("id",b.ProcessGUID),a.writeElementString("Description",jshelper.escapeHtml(b.Description))}function c(a,b){if(b&&b.participants){var c=b.participants;if(c&&c.length>0){a.writeStartElement("Participants");for(var d=0;d<c.length;d++){var e=c[d];a.writeStartElement("Participant"),a.writeAttributeString("type",e.type),a.writeAttributeString("id",e.id),a.writeAttributeString("name",e.name),a.writeAttributeString("code",e.code),a.writeAttributeString("outerId",e.outerId),a.writeEndElement()}a.writeEndElement()}}}function d(a,b){a.writeStartElement("Layout"),a.writeStartElement("Swimlanes");for(var c=b.getChildVertices(kmain.mxGraphEditor.graph.getDefaultParent()),d=0;d<c.length;d++){var e=c[d],f=b.getValue(e);"Swimlane"===f.nodeName&&(a.writeStartElement("Swimlane"),a.writeAttributeString("id",e.id),a.writeAttributeString("name",f.getAttribute("label")),a.writeStartElement("Geography"),a.writeAttributeString("parent",e.parent.id),a.writeAttributeString("style",e.style),a.writeStartElement("Widget"),a.writeAttributeString("left",e.geometry.x),a.writeAttributeString("top",e.geometry.y),a.writeAttributeString("width",e.geometry.width),a.writeAttributeString("height",e.geometry.height),a.writeEndElement(),a.writeEndElement(),a.writeEndElement())}a.writeEndElement(),a.writeEndElement()}function e(a,b){var c=b.getChildVertices(kmain.mxGraphEditor.graph.getDefaultParent()),d=null,e=null,g=null,h=null;if(c.length>0){a.writeStartElement("Activities");for(var i=0;i<c.length;i++)if(d=c[i],e=b.getValue(d),"Activity"===e.nodeName&&f(a,d,e),"Swimlane"===e.nodeName)for(var j=b.getChildVertices(b.getCell(d.id)),k=0;k<j.length;k++)g=j[k],h=b.getValue(g),"Activity"===h.nodeName?f(a,g,h):window.console.log("invalid node type:"+h.nodeName);a.writeEndElement()}}function f(a,b,c){var d=null,e="",f=null,g=null;if(a.writeStartElement("Activity"),a.writeAttributeString("id",b.id),a.writeAttributeString("name",c.getAttribute("label")),a.writeAttributeString("code",c.getAttribute("code")),f=c.getElementsByTagName("Description")[0],f&&a.writeElementString("Description",jshelper.escapeHtml(f.textContent)),d=c.getElementsByTagName("ActivityType")[0],e=d.getAttribute("type"),a.writeStartElement("ActivityType"),a.writeAttributeString("type",e),"GatewayNode"==e?(a.writeAttributeString("gatewaySplitJoinType",d.getAttribute("gatewaySplitJoinType")),a.writeAttributeString("gatewayDirection",d.getAttribute("gatewayDirection"))):"SubProcessNode"==e?a.writeAttributeString("subId",d.getAttribute("subId")):"MultipleInstanceNode"==e&&(a.writeAttributeString("complexType",d.getAttribute("complexType")),a.writeAttributeString("mergeType",d.getAttribute("mergeType")),a.writeAttributeString("compareType",d.getAttribute("compareType")),a.writeAttributeString("completeOrder",d.getAttribute("completeOrder"))),a.writeEndElement(),g=c.getElementsByTagName("Performers")[0]){var h=g.getElementsByTagName("Performer");if(h.length>0){a.writeStartElement("Performers");for(var i=0;i<h.length;i++){var j=h[i];a.writeStartElement("Performer"),a.writeAttributeString("id",j.getAttribute("id")),a.writeEndElement()}a.writeEndElement()}}a.writeStartElement("Geography"),a.writeAttributeString("parent",b.parent.id),a.writeAttributeString("style",b.style),a.writeStartElement("Widget"),a.writeAttributeString("left",b.geometry.x),a.writeAttributeString("top",b.geometry.y),a.writeAttributeString("width",b.geometry.width),a.writeAttributeString("height",b.geometry.height),a.writeEndElement(),a.writeEndElement(),a.writeEndElement()}function g(a,b){a.writeStartElement("Transitions"),h(a,b,b.getChildEdges(kmain.mxGraphEditor.graph.getDefaultParent()));for(var d=null,e=i(b),f=0;f<e.length;f++)d=b.getChildEdges(b.getCell(e[f])),h(a,b,d);a.writeEndElement()}function h(a,b,c){var d=null,e=null;if(c.length>0)for(var f=0;f<c.length;f++)d=c[f],e=b.getValue(d),"Transition"===e.nodeName&&j(a,d,e)}function i(a){for(var b=[],c=a.getChildVertices(kmain.mxGraphEditor.graph.getDefaultParent()),d=null,e=null,f=0;f<c.length;f++)d=c[f],e=a.getValue(d),"Swimlane"===e.nodeName&&b.push(d.id);return b}function j(a,b,c){var d=null,e="";conditionNode=null,conditionType="",conditionTextNode=null,a.writeStartElement("Transition"),a.writeAttributeString("id",b.id),a.writeAttributeString("from",b.source.id),a.writeAttributeString("to",b.target.id),descriptionNode=c.getElementsByTagName("Description")[0],descriptionNode&&a.writeElementString("Description",jshelper.escapeHtml(descriptionNode.textContent)),d=c.getElementsByTagName("Receiver")[0],d&&(a.writeStartElement("Receiver"),e=d.getAttribute("type"),!1===$.isEmptyObject(e)&&"undefined"!==e&&a.writeAttributeString("type",e),a.writeEndElement()),conditionNode=c.getElementsByTagName("Condition")[0],conditionNode&&(a.writeStartElement("Condition"),conditionType=conditionNode.getAttribute("type"),!1===$.isEmptyObject(conditionType)&&"undefined"!==conditionType&&(a.writeAttributeString("type",conditionType),conditionTextNode=conditionNode.getElementsByTagName("ConditionText")[0],!1===$.isEmptyObject(conditionTextNode)&&(a.writeStartElement("ConditionText"),a.writeCDATA($.trim(conditionTextNode.textContent)),a.writeEndElement())),a.writeEndElement()),a.writeStartElement("Geography"),a.writeAttributeString("parent",b.parent.id),a.writeAttributeString("style",b.style),a.writeEndElement(),a.writeEndElement()}return a.load=function(a){var b={},c={},d=[],e=$.parseXML(a.XmlContent);b.participants=d,b.process=c,$(e).find("Participant").each(function(a){var b={};b.type=$(this).attr("type"),b.id=$(this).attr("id"),b.name=$(this).attr("name"),b.code=$(this).attr("code"),b.outerId=$(this).attr("outerId"),d.push(b)});var f=$(e).find("Process");if(f){var g=[],h=[],i=[];c.name=$(f).attr("name"),c.id=$(f).attr("id");var j=$(f).children("Description");c.description=jshelper.replaceHTMLTags($(j).text());var k=$(f).children("Layout");if(k){var l=$(k).children("Swimlanes");$(l).find("Swimlane").each(function(a){var b=this,c={},e={},f=null,g={};c.id=$(b).attr("id"),c.name=$(b).attr("name"),geographyElement=$(b).children("Geography"),geographyElement&&(e.parent=$(geographyElement).attr("parent"),e.style=$(geographyElement).attr("style"),f=$(geographyElement).children("Widget"),f&&(g.left=parseInt($(f).attr("left")),g.top=parseInt($(f).attr("top")),g.width=parseInt($(f).attr("width")),g.height=parseInt($(f).attr("height")),e.widget=g),c.geography=e),i.push(c)})}c.swimlanes=i,c.activities=g,c.transitions=h,$(f).find("Activity").each(function(a){var b=this,c={},d={},e=[],f={},h={},i={},j={};c.id=$(b).attr("id"),c.name=$(b).attr("name"),c.code=$(b).attr("code"),c.text="";var k=$(b).find("Description");c.description=jshelper.replaceHTMLTags($(k).text()),d=$(b).find("ActivityType"),c.type=$(d).attr("type"),"GatewayNode"==c.type?(c.gatewaySplitJoinType=$(d).attr("gatewaySplitJoinType"),c.gatewayDirection=$(d).attr("gatewayDirection")):"SubProcessNode"==c.type?c.subId=$(d).attr("subId"):"MultipleInstanceNode"==c.type&&(c.complexType=$(d).attr("complexType"),c.mergeType=$(d).attr("mergeType"),c.compareType=$(d).attr("compareType"),c.completeOrder=$(d).attr("completeOrder")),$(b).find("Performer").each(function(a){var b=this,c={};c.id=$(b).attr("id"),e.push(c)}),c.performers=e,f=$(b).find("Geography"),i.parent=$(f).attr("parent"),i.style=$(f).attr("style"),h=$(f).find("Widget"),j.left=parseInt($(h).attr("left")),j.top=parseInt($(h).attr("top")),j.width=parseInt($(h).attr("width")),j.height=parseInt($(h).attr("height")),i.widget=j,c.geography=i,g.push(c)}),$(e).find("Transition").each(function(a){var b=this,c={},d={},f={};c.id=$(b).attr("id"),c.from=$(b).attr("from"),c.to=$(b).attr("to");var i=$(b).find("Description");c.description=jshelper.replaceHTMLTags($(i).text());var j={},k=$(b).find("Receiver"),l=$(k).attr("type");void 0!==l&&(j.type=l),c.receiver=j;var m={},n=$(b).find("Condition");if(n){m.type=$(n).attr("type");$(n).find("ConditionText")&&(m.text=jshelper.replaceHTMLTags($(n).text()))}c.condition=m,d=$(b).find("Geography"),d&&(f.parent=$(d).attr("parent"),f.style=$(d).attr("style")),c.geography=f,h.push(c)})}var m={processGUID:a.ProcessGUID,version:a.Version,package:b};return new kmodel.GraphData(m)},a.serialize2Xml=function(a,f){if(!a)return null;var h=new XMLWriter("utf-8","1.0");h.formatting="indented",h.indentChar=" ",h.indentation=2,h.writeStartDocument(void 0),h.writeStartElement("Package"),c(h,f),b(h,a);var i=kmain.mxGraphEditor.graph.getModel();d(h,i),e(h,i),g(h,i),h.writeEndElement(),h.writeEndElement(),h.writeEndElement(),h.writeEndDocument();var j=h.flush();return h.close(),j},a}(),kmain=function(){function a(){}function b(){a.mxSelectedProcessEntity=null,a.mxSelectedDomElement={},a.mxSelectedPackageData=null,a.mxSelectedParticipants=null}function c(){a.mxGraphEditor=g("scripts/mxGraph/src/editor/config/workfloweditor.xml"),a.mxGraphEditor.addListener(mxEvent.SAVE,function(){a.saveProcessFile()}),a.mxGraphEditor.graph.addListener(mxEvent.CELLS_ADDED,function(a){}),a.mxGraphEditor.graph.addMouseListener({mouseDown:function(a,b){},mouseMove:function(a,b){},mouseUp:function(a,b){}}),a.mxGraphEditor.createProperties=function(b){var c=this.graph.getModel(),g=c.getValue(b);if(mxUtils.isNode(g))if(a.mxSelectedDomElement.Cell=b,c.isVertex(b))if("Activity"===g.nodeName){a.mxSelectedDomElement.ElementType="Activity";var h=a.mxSelectedDomElement.Element=e(b);d(h)}else g.nodeName;else if(c.isEdge(b)&&"Transition"===g.nodeName){a.mxSelectedDomElement.ElementType="Transition";var i=a.mxSelectedDomElement.Element=f(b);BootstrapDialog.show({title:"转移属性",message:$("<div></div>").load("transition/edit"),data:{node:i}})}}}function d(a){if(a.type===kmodel.Config.NODE_TYPE_TASK||a.type===kmodel.Config.NODE_TYPE_MULTIPLEINSTANCE)BootstrapDialog.show({title:"活动属性",message:$("<div></div>").load("activity/edit"),data:{node:a}});else if(a.type===kmodel.Config.NODE_TYPE_GATEWAY)BootstrapDialog.show({title:"网关决策属性",message:$("<div></div>").load("activity/gateway"),data:{node:a}});else if(a.type===kmodel.Config.NODE_TYPE_SUBPROCESS)BootstrapDialog.show({title:"子流程属性",message:$("<div></div>").load("activity/subprocess"),data:{node:a}});else if(a.type!==kmodel.Config.NODE_TYPE_START&&a.type!==kmodel.Config.NODE_TYPE_END)return $.msgBox({title:"Designer / Property",content:"未知节点类型！"+a.type,type:"alert"}),!1}function e(b){var c=a.mxGraphEditor.graph.getModel(),d=c.getValue(b),e={};e.id=d.getAttribute("id"),e.name=d.getAttribute("label"),e.code=d.getAttribute("code");var f=d.getElementsByTagName("Description")[0];f&&(e.description=f.textContent);var g=d.getElementsByTagName("ActivityType")[0];e.type=g.getAttribute("type"),e.type===kmodel.Config.NODE_TYPE_MULTIPLEINSTANCE?(e.complexType=g.getAttribute("complexType"),e.mergeType=g.getAttribute("mergeType"),e.compareType=g.getAttribute("compareType"),e.completeOrder=g.getAttribute("completeOrder")):e.type===kmodel.Config.NODE_TYPE_GATEWAY?(e.gatewaySplitJoinType=g.getAttribute("gatewaySplitJoinType"),e.gatewayDirection=g.getAttribute("gatewayDirection")):e.type===kmodel.Config.NODE_TYPE_SUBPROCESS&&(e.subId=g.getAttribute("subId"));var h=d.getElementsByTagName("Performers")[0];if(h){var i=h.getElementsByTagName("Performer");i.length>0&&(e.performers=[]);for(var j=0;j<i.length;j++){var k={};k.id=i[j].getAttribute("id"),e.performers.push(k)}}return e}function f(b){var c=a.mxGraphEditor.graph.getModel(),d=c.getValue(b),e={};e.id=d.getAttribute("id"),e.from=d.getAttribute("from"),e.to=d.getAttribute("to");var f=d.getElementsByTagName("Description")[0];f&&(e.description=f.textContent);var g=d.getElementsByTagName("Condition")[0];if(g){var h={};h.type=g.getAttribute("type");var i=g.getElementsByTagName("ConditionText")[0];h.text=i.textContent}e.condition=h;var j=d.getElementsByTagName("Receiver")[0];if(j){var k={};k.type=j.getAttribute("type")}return e.receiver=k,e}function g(a){var b=null;try{if(mxClient.isBrowserSupported()){mxObjectCodec.allowEval=!0;var c=mxUtils.load(a).getDocumentElement();b=new mxEditor(c),mxObjectCodec.allowEval=!1,b.graph.createPanningManager=function(){var a=new mxPanningManager(this);return a.border=30,a},b.graph.allowAutoPanning=!0,b.graph.timerAutoScroll=!0;var d=document.title,e=function(a){document.title=d+" - "+a.getTitle()};b.addListener(mxEvent.OPEN,e),b.addListener(mxEvent.ROOT,e),e(b),b.setStatus("mxGraph "+mxClient.VERSION)}else $.msgBox({title:"Designer / Index",content:"不支持当前版本的浏览器，请使用更新版本的浏览器！",type:"info"})}catch(a){throw $.msgBox({title:"Designer / Index",content:"图形设计器启动异常："+a.message,type:"info"}),a}return b}function h(c,d){b(),a.mxSelectedProcessEntity=d.ProcessEntity,a.saveProcessFile()}function i(c,d){b();var e={ProcessGUID:d.ProcessEntity.ProcessGUID,Version:d.ProcessEntity.Version};processapi.queryProcessFile(e,function(b){if(1===b.Status){a.mxGraphEditor.graph.getModel().clear();var c=kloader.load(b.Entity);a.mxSelectedPackageData=c.package,a.mxSelectedParticipants=c.package.participants,a.mxSelectedProcessEntity=d.ProcessEntity}else $.msgBox({title:"Designer / Process",content:"流程定义记录读取失败！错误："+b.Message,type:"error"})})}function k(){$(".progress .progress-bar").progressbar({transition_delay:200});var a=$(".js-loading-bar");a.find(".bar");a.modal("show"),setTimeout(function(){a.modal("hide")},500)}return a.init=function(){k(),$("#kgraphCanvas").on("click",function(a){$(this).focus()}),$.fn.modal.Constructor.prototype.enforceFocus=function(){},processlist.afterCreated.subscribe(h),processlist.afterOpened.subscribe(i),c()},a.createProcess=function(){a.mxGraphEditor.graph.getModel().clear(),processlist.createProcess()},a.openProcess=function(){BootstrapDialog.show({title:"流程列表",message:$("<div></div>").load("process/list")})},a.setting=function(){BootstrapDialog.show({title:"系统参数设置",message:$("<div>你可以在这个页面设置一些参数。。。</div>"),buttons:[{label:"确定",cssClass:"btn-primary",action:function(a){a.close()}}]})},a.previewXml=function(){var b=kloader.serialize2Xml(a.mxSelectedProcessEntity,a.mxSelectedPackageData);if(!1!==$.isEmptyObject(b))return void $.msgBox({title:"Designer / Index",content:"图形内容为空，请确认是否打开流程记录！",type:"error"});var c=$("<div></div>");$('<textarea style="width:540px;min-height:280px;"/>').val(b).appendTo(c);BootstrapDialog.show({title:"XML文件内容",message:c,buttons:[{label:"关闭",cssClass:"btn-primary",action:function(a){a.close()}}]})},a.importDiagram=function(){BootstrapDialog.show({title:"导入XML",message:$("<div></div>").load("process/import")})},a.saveProcessFile=function(){if(a.mxSelectedProcessEntity){var b=kloader.serialize2Xml(a.mxSelectedProcessEntity,a.mxSelectedPackageData),c={ProcessGUID:a.mxSelectedProcessEntity.ProcessGUID,Version:a.mxSelectedProcessEntity.Version,XmlContent:b};processapi.saveProcessFile(c)}else processlist.createProcess()},a.setVertexValue=function(b){var c=a.mxGraphEditor.graph.getModel(),d=c.getValue(a.mxSelectedDomElement.Cell);d.setAttribute("label",b.name),d.setAttribute("code",b.code);var e=d.getElementsByTagName("Description")[0];e||(e=d.appendChild(d.ownerDocument.createElement("Description"))),e.textContent=b.description;var f=d.getElementsByTagName("ActivityType")[0];b.type===kmodel.Config.NODE_TYPE_MULTIPLEINSTANCE?(f.setAttribute("complexType",b.complexType),f.setAttribute("mergeType",b.mergeType),f.setAttribute("compareType",b.compareType),f.setAttribute("completeOrder",b.completeOrder)):b.type===kmodel.Config.NODE_TYPE_GATEWAY?(f.setAttribute("gatewaySplitJoinType",b.gatewaySplitJoinType),f.setAttribute("gatewayDirection",b.gatewayDirection)):b.type===kmodel.Config.NODE_TYPE_SUBPROCESS&&f.setAttribute("subId",b.subId),c.beginUpdate();try{c.setValue(a.mxSelectedDomElement.Cell,d)}finally{c.endUpdate()}},a.setVertexPerformers=function(b){var c=a.mxGraphEditor.graph.getModel(),d=c.getValue(a.mxSelectedDomElement.Cell);if(b){var e=d.getElementsByTagName("Performers")[0];if(e)for(var f=e.getElementsByTagName("Performer"),g=0;g<f.length;g++)e.removeChild(f[g]);else e=d.appendChild(d.ownerDocument.createElement("Performers"));for(var h=null,i=null,g=0;g<b.length;g++)h=b[g],i=e.appendChild(e.ownerDocument.createElement("Performer")),i.setAttribute("id",h.id)}c.beginUpdate();try{c.setValue(a.mxSelectedDomElement.Cell,d)}finally{c.endUpdate()}},a.setEdgeValue=function(b){var c=a.mxGraphEditor.graph.getModel(),d=c.getValue(a.mxSelectedDomElement.Cell),e=d.getElementsByTagName("Description")[0];if(e||(e=d.appendChild(d.ownerDocument.createElement("Description"))),e.textContent=b.description,d.setAttribute("label",b.description),d.setAttribute("from",b.from),d.setAttribute("to",b.to),b.condition){var f=d.getElementsByTagName("Condition")[0];f||(f=d.appendChild(d.ownerDocument.createElement("Condition"))),f.setAttribute("type",b.condition.type);var g=f.getElementsByTagName("ConditionText")[0];g||(g=f.appendChild(d.ownerDocument.createElement("ConditionText"))),g.textContent=b.condition.text}var h=d.getElementsByTagName("Receiver")[0];h||(h=d.appendChild(d.ownerDocument.createElement("Receiver"))),h.setAttribute("type",b.receiver.type),c.beginUpdate();try{c.setValue(a.mxSelectedDomElement.Cell,d)}finally{c.endUpdate()}},a}(),kmodel=function(){function a(){}return a.Config={NODE_PREFIX:"ACT",NODE_TYPE_START:"StartNode",NODE_TYPE_TASK:"TaskNode",NODE_TYPE_END:"EndNode",NODE_TYPE_GATEWAY:"GatewayNode",NODE_TYPE_SUBPROCESS:"SubProcessNode",NODE_TYPE_MULTIPLEINSTANCE:"MultipleInstanceNode",NODE_TYPE_COMPLEX_SIGNTOGETHER:"SignTogether",NODE_TYPE_COMPLEX_SIGHFORWARD:"SignForward",ELEMENT_TYPE_NODE:"NODE",ELEMENT_TYPE_CONNECTION:"CONNECTION"},a.GraphData=function(a){function b(a){var b=null,c=[];if(a&&a.length>0){var d=kmain.mxGraphEditor.graph,e=d.getModel();e.beginUpdate();try{for(var f=0;f<a.length;f++)b=mxtoolkit.insertSwimlane(d,a[f]),c.push(b)}finally{e.endUpdate()}}return c}function c(a){var b=null,c=[];if(a&&a.length>0){var d=kmain.mxGraphEditor.graph,e=d.getModel();e.beginUpdate();try{for(var f=0;f<a.length;f++)b=mxtoolkit.insertVertex(d,a[f]),c.push(b)}finally{e.endUpdate()}}return c}function d(a){var c=[];if(a&&a.length>0){var d=kmain.mxGraphEditor.graph,e=d.getModel();e.beginUpdate();try{for(var f=0;f<a.length;f++)mxtoolkit.insertEdge(d,a[f]),c.push(null)}finally{e.endUpdate()}}return c}this.package=a.package,this.process=a.package.process,this.yongdaos=b(this.process.swimlanes),this.nodes=c(this.process.activities),this.lines=d(this.process.transitions)},a}(),mxconfig=function(){function a(){}return a.style={},a.style.start="symbol;image=scripts/mxGraph/src/editor/images/symbols/event.png",a.style.end="symbol;image=scripts/mxGraph/src/editor/images/symbols/event_end.png",a.style.subprocess="rectangle",a.style["gateway-split"]="symbol;image=scripts/mxGraph/src/editor/images/symbols/fork.png",a.style["gateway-join"]="symbol;image=scripts/mxGraph/src/editor/images/symbols/merge.png",a.style.subprocess="rounded",a.style.multipleinstance="symbol;image=scripts/mxGraph/src/editor/images/symbols/samll_multiple_instance_task.png",a.getVertexStyle=function(b){var c=null,d=b.type;if(d===kmodel.Config.NODE_TYPE_START)c=a.style.start;else if(d===kmodel.Config.NODE_TYPE_END)c=a.style.end;else if(d===kmodel.Config.NODE_TYPE_TASK)c=a.style.task;else if(d===kmodel.Config.NODE_TYPE_MULTIPLEINSTANCE)c=a.style.multipleinstance;else if(d===kmodel.Config.NODE_TYPE_GATEWAY)c=a.style["gateway-split"];else{if(d!==kmodel.Config.NODE_TYPE_SUBPROCESS)throw new Error("未知节点类型！");c=a.style.subprocess}return c},a}(),mxtoolkit=function(){function a(){}function b(a){var b=mxUtils.createXmlDocument(),c=b.createElement("Activity");c.setAttribute("label",a.name),c.setAttribute("code",a.code);var d=b.createElement("Description");c.appendChild(d);var e=b.createTextNode(a.description);d.appendChild(e);var f=a.type,g=b.createElement("ActivityType");if(g.setAttribute("type",f),f===kmodel.Config.NODE_TYPE_START);else if(f===kmodel.Config.NODE_TYPE_END);else if(f===kmodel.Config.NODE_TYPE_TASK);else if(f===kmodel.Config.NODE_TYPE_GATEWAY)g.setAttribute("gatewaySplitJoinType",a.gatewaySplitJoinType),g.setAttribute("gatewayDirection",a.gatewayDirection);else if(f===kmodel.Config.NODE_TYPE_SUBPROCESS)g.setAttribute("subId",a.subId);else{if(f!==kmodel.Config.NODE_TYPE_MULTIPLEINSTANCE)throw new Error("未知节点类型！");g.setAttribute("complexType",a.complexType),g.setAttribute("mergeType",a.mergeType),g.setAttribute("compareType",a.compareType),g.setAttribute("completeOrder",a.completeOrder)}if(c.appendChild(g),a.performers&&a.performers.length>0){var h=b.createElement("Performers");c.appendChild(h);for(var i=null,j=0;j<a.performers.length;j++)i=b.createElement("Performer"),h.appendChild(i),i.setAttribute("id",a.performers[j].id)}return c}return a.insertSwimlane=function(a,b){var c=mxUtils.createXmlDocument(),d=c.createElement("Swimlane");d.setAttribute("label",b.name);var f=(a.getModel(),a.getDefaultParent()),g=b.geography,h=g.widget,b=a.insertVertex(f,b.id,d,h.left,h.top,h.width,h.height,g.style);return b},a.insertVertex=function(a,c){var d=c.geography,e=a.getModel(),f=e.getCell(d.parent);f||(f=a.getDefaultParent());var g=d.widget;return a.insertVertex(f,c.id,b(c),g.left,g.top,g.width,g.height,d.style)},a.insertEdge=function(a,b){var c=mxUtils.createXmlDocument(),d=c.createElement("Transition");d.setAttribute("from",b.from),d.setAttribute("to",b.to);var e=c.createElement("Description");d.appendChild(e);var f=c.createTextNode(b.description);if(e.appendChild(f),d.setAttribute("label",b.description),!1===$.isEmptyObject(b.condition)){var g=c.createElement("Condition");g.setAttribute("type",b.condition.type);var h=c.createElement("ConditionText");g.appendChild(h);var i=c.createTextNode($.trim(b.condition.text));h.appendChild(i),d.appendChild(g)}if(!1===$.isEmptyObject(b.receiver)){var j=c.createElement("Receiver");j.setAttribute("type",b.receiver.type),d.appendChild(j)}var k=b.geography,l=a.getModel(),m=l.getCell(k.parent);return m||(m=a.getDefaultParent()),a.insertEdge(m,b.id,d,a.getModel().getCell(b.from),a.getModel().getCell(b.to))},a}(),processlist=function(){function a(){}return a.pselectedProcessEntity=null,a.afterCreated=new slick.Event,a.afterOpened=new slick.Event,a.getProcessList=function(){$("#loading-indicator").show(),jshelper.ajaxGet("api/Wf2Xml/GetProcessListSimple",null,function(b){function e(){var b=d.api.getSelectedRows();b.forEach(function(b,c){a.pselectedProcessEntity=b})}function f(b,c){a.editProcess()}if(1===b.Status){var c=document.querySelector("#myProcessGrid");$(c).empty();var d={columnDefs:[{headerName:"ID",field:"ID",width:50},{headerName:"流程GUID",field:"ProcessGUID",width:120},{headerName:"流程名称",field:"ProcessName",width:200},{headerName:"版本",field:"Version",width:40},{headerName:"状态",field:"IsUsing",width:40},{headerName:"创建日期",field:"CreatedDateTime",width:120}],rowSelection:"single",onSelectionChanged:e,onRowDoubleClicked:f};new agGrid.Grid(c,d),d.api.setRowData(b.Entity),$("#loading-indicator").hide()}})},a.createProcess=function(){a.pselectedProcessEntity=null,BootstrapDialog.show({title:"流程新建",message:$("<div></div>").load("process/edit")})},a.loadProcess=function(){var b=a.pselectedProcessEntity;null!==b?($("#txtProcessGUID").val(b.ProcessGUID),$("#txtProcessName").val(b.ProcessName),$("#txtVersion").val(b.Version),$("#ddlIsUsing").val(b.IsUsing),$("#txtDescription").val(b.Description)):($("#txtProcessGUID").val(""),$("#txtProcessName").val(""),$("#txtVersion").val("1"),$("#ddlIsUsing").val(),$("#txtDescription").val(""))},a.editProcess=function(){if(null==a.pselectedProcessEntity)return $.msgBox({title:"Designer / Process",content:"请先选择流程记录！",type:"alert"}),!1;BootstrapDialog.show({title:"流程编辑",message:$("<div></div>").load("process/edit")})},a.saveProcess=function(){if(""==$("#txtProcessName").val()||""==$("#txtVersion").val())return $.msgBox({title:"Designer / Process",content:"请输入流程基本信息！",type:"alert"}),!1;var b={ProcessGUID:$("#txtProcessGUID").val(),ProcessName:$("#txtProcessName").val(),Version:$("#txtVersion").val(),IsUsing:$("#ddlIsUsing").val(),Description:$("#txtDescription").val()};null===a.pselectedProcessEntity?processapi.create(b,function(b){1==b.Status&&(a.pselectedProcessEntity=b.Entity,a.afterCreated&&slick.trigger(a.afterCreated,{ProcessEntity:b.Entity}))}):processapi.update(b)},a.deleteProcess=function(){$.msgBox({title:"Are You Sure",content:"确实要删除流程定义记录吗? ",type:"confirm",buttons:[{value:"Yes"},{value:"Cancel"}],success:function(b){if("Yes"==b){var c={ProcessGUID:a.pselectedProcessEntity.ProcessGUID,Version:a.pselectedProcessEntity.Version};return void processapi.delete(c)}}})},a.sure=function(){null!==a.pselectedProcessEntity&&a.afterOpened&&slick.trigger(a.afterOpened,{ProcessEntity:a.pselectedProcessEntity})},a.initXmlImport=function(){new qq.FineUploader({element:document.getElementById("fine-uploader-validation"),template:"qq-template-validation",request:{endpoint:"api/FineUpload/import",params:{extraParam1:"1",extraParam2:"2"}},thumbnails:{placeholders:{waitingPath:"Content/fineuploader/waiting-generic.png",notAvailablePath:"Content/fineuploader/not_available-generic.png"}},validation:{allowedExtensions:["xml","txt"],itemLimit:1,sizeLimit:51200},callbacks:{onComplete:function(a,b,c){1==c.success?$.msgBox({title:"Designer / Process",content:c.Message,type:"info",buttons:[{value:"Ok"}]}):$.msgBox({title:"Designer / Process",content:c.ExceptionMessage,type:"error",buttons:[{value:"Ok"}]})}}})},a}(),processapi=function(){function a(){}return a.create=function(a,b){jshelper.ajaxPost("api/Wf2Xml/CreateProcess",JSON.stringify(a),function(a){1==a.Status?$.msgBox({title:"Designer / Process",content:"新创建流程记录成功保存！",type:"info"}):$.msgBox({title:"Designer / Process",content:a.Message,type:"error",buttons:[{value:"Ok"}]}),b(a)})},a.update=function(a){jshelper.ajaxPost("api/Wf2Xml/UpdateProcess",JSON.stringify(a),function(a){1==a.Status?$.msgBox({title:"Designer / Process",content:"流程记录成功保存！",type:"info"}):$.msgBox({title:"Ooops",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a.delete=function(a){jshelper.ajaxPost("api/Wf2Xml/DeleteProcess",JSON.stringify(a),function(a){1==a.Status?($.msgBox({title:"Designer / Process",content:"流程记录已经删除！",type:"info"}),processlist.getProcessList()):$.msgBox({title:"Ooops",content:a.Message,type:"error",buttons:[{value:"Ok"}]})})},a.queryProcessFile=function(a,b){jshelper.ajaxPost("api/Wf2Xml/QueryProcessFile",JSON.stringify(a),function(a){b(a)})},a.saveProcessFile=function(a){jshelper.ajaxPost("api/Wf2Xml/SaveProcessFile",JSON.stringify(a),function(a){"1"==a.Status?$.msgBox({title:"Designer / Index",content:"流程XML内容保存成功！",type:"info"}):$.msgBox({title:"Designer / Index",content:"流程XML内容保存失败！错误信息："+a.Message,type:"info"})})},a}(),rolelist=function(){function a(){}var b="",c=null;return a.getRoleList=function(){jshelper.ajaxGet("api/Wf2Xml/GetRoleAll",null,function(a){function f(){e.api.getSelectedRows().forEach(function(a,d){b="role",c=a})}if(1==a.Status){var d=document.querySelector("#myRoleGrid"),e={columnDefs:[{headerName:"ID",field:"ID",width:60},{headerName:"角色名称",field:"RoleName",width:200},{headerName:"角色代码",field:"RoleCode",width:200}],rowSelection:"single",onSelectionChanged:f};new agGrid.Grid(d,e),e.api.setRowData(a.Entity)}})},a.sure=function(){""!=b&&null!=c?activityproperty.syncActivityPerformers(b,c):$.msgBox({title:"Designer / Role",content:"请选择角色记录！",type:"alert"})},a}(),subprocessmanager;subprocessmanager||(subprocessmanager={}),function(){function c(){$.msgBox({title:"Are You Sure",content:"请确认要将当前选中记录设置为子流程吗？！",type:"confirm",buttons:[{value:"Yes"},{value:"Cancel"}],success:function(c){if("Yes"==c){$("#txtProcessGUID").val(a),$("#txtProcessName").val(b);var d=kmain.mxSelectedDomElement.Element;return void(d&&(d.subId=a,kmain.setVertexValue(d)))}}})}var a=null,b=null;subprocessmanager.load=function(){var a=kmain.mxSelectedDomElement.Element;window.console.log(a),null!==a&&""!==a.subId&&($("#txtProcessGUID").val(a.subId),subprocessmanager.getProcess(a.subId)),subprocessmanager.getProcessList()},subprocessmanager.getProcessList=function(){$("#spinner").show(),jshelper.ajaxGet("api/Wf2Xml/GetProcessListSimple",null,function(c){function f(){var d=0;e.api.getSelectedRows().forEach(function(c,e){d=c.ID,a=c.ProcessGUID,b=c.ProcessName})}function g(a,b){}if(1===c.Status){var d=document.querySelector("#mySubProcessGrid"),e={columnDefs:[{headerName:"ID",field:"ID",width:50},{headerName:"流程GUID",field:"ProcessGUID",width:120},{headerName:"流程名称",field:"ProcessName",width:160},{headerName:"版本",field:"Version",width:40},{headerName:"状态",field:"IsUsing",width:60},{headerName:"创建日期",field:"CreatedDateTime",width:120}],rowSelection:"single",onSelectionChanged:f,onRowDoubleClicked:g};new agGrid.Grid(d,e),e.api.setRowData(c.Entity),$("#loading-indicator").hide()}})},subprocessmanager.getProcess=function(a){null!==a&&void 0!==a&&jshelper.ajaxGet("api/Wf2Xml/GetProcess/"+a,null,function(a){if(1==a.Status){var b=a.Entity;$("#txtProcessName").val(b.ProcessName)}})},subprocessmanager.saveSubProcess=function(){c()}}();var transitionproperty=function(){function a(){}return a.load=function(){var a=kmain.mxSelectedDomElement.Element;a&&($("#txtDescription").val(a.description),a.receiver&&a.receiver.type&&$("#ddlReceiverType").val(a.receiver.type),a.condition&&$("#txtCondition").val($.trim(a.condition.text)))},a.save=function(){var a=$("#txtDescription").val(),b={},c=$("#ddlReceiverType").val();"default"!==c&&(b.type=c);var d={};d.type="Expression",d.text=$.trim($("#txtCondition").val());var e=kmain.mxSelectedDomElement.Element;null!==e&&(e.description=a,e.receiver=b,e.condition=d,kmain.setEdgeValue(e))},a}();